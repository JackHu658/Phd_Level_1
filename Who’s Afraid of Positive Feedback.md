# Who’s Afraid of Positive Feedback?

对于具有正反馈的正常控制回路，我们要么认为它不能做，要么认为它不应该做。大多数关于电路，甚至控制理论的教科书，都倾向于用几句关于指数增长和必然失效的句子来回避这个话题。这些心理障碍是从哪里来的?尽管有那么多负面报道，但正反馈远比你想象的要普遍和有用得多。

## 文献

> C. Mangelsdorf, "Who’s Afraid of Positive Feedback? [Shop Talk: What you didn’t Learn in School]," in IEEE Solid-State Circuits Magazine, vol. 16, no. 3, pp. 19-26, Summer 2024

## 说些人都知道的

当反馈路径中的信号与误差信号（即求和点的输出）相加，使其增大而非减小时，我们称之为正反馈。换句话说，环路的信号增益为正。这可以是直流意义上的，也可以是交流意义上的。正反馈环路的这种自馈特性往往会导致我们所预期的结果：灾难。但完整的情况要复杂一些。

从波特图上来看，表示的是当相移为-180度时，环路增益小于1（0dB）才不会发生正反馈。这是因为，当我们将求和节点处的反相考虑在内时，整个环路的总相移为360°或0°，这显然是正反馈。因此，我们要确保增益小于1从而抑制求和信号（误差信号）比输入信号更大的情况存在。

对于环路增益（当反馈系数$f=1$的时候，即为开环增益）正反馈存在的条件是当环路的相位达到-90°的时候，信号就会出现负的实分量，正反馈在这时其实就已经发生了。且由于主导极点和积分器型补偿，在我们处理任何其他极点之前，相位初始值为−90°。换句话说，几乎所有环路在某些频率下都具有增益大于1的正反馈！

## 说些没那么多人知道的

在任何频率下，环路增益的大小决定了该频率下电路的精度和失真性能。为了在更高频率下最大化环路增益，可以将主极点补偿换成双极点滚降，如下图所示。当然，这必须加入一个零点，从而确保在0dB的时候有足够的相位裕度

![alt text](<Pictures/Who’s Afraid of Positive Feedback-image.png>)

但问题是在相位：此处可以看到，当增益仍然相当高（实际上超过80 dB）时，反馈确实会降至−180°，但系统仍然完全稳定。

![alt text](<Pictures/Who’s Afraid of Positive Feedback-image-1.png>)

从基本的Phase Margin和Gain Margin角度来看系统是不稳定，但从数学角度（虽然也不那么严谨）来看，系统是稳定的，根据传递函数来看：
$$H=\frac{A}{1+Af}$$
唯一有可能出问题的就是分母，但是如果当相移到-180°的时候，$Af$还非常大，那么最终的输出约为$1/f$，无论相位这时候是如何的，都不会使得输出接近于无穷，因此稳定是可能的
这也说明了根据Phase Margin和Gain Margin判据来看不稳定性存在一定的漏洞（当然很多数情况下是很有用的，如果这个判据没用就需要去根据Nyquist判据来确认）

## 负阻抗的奇妙世界

负阻抗可以用电压源来类比，可以理解为电流从电压源的负端流入正端流出，但是两端的电压却是正端大于负端，相对于电流的流过非但没有消耗功率，还给电流的流动提供了能量！

从来没有人能在自然界中捕捉到无源负电阻。即便真的捕捉到了，它也很可能会自发爆炸。这是因为负电阻必须产生功率，而不是消耗功率。它不可能是无源器件。但如果存在这样的装置，它将在各种应用中非常有用。正反馈环路使得能够合成这种奇妙元件。这种电路被称为负阻抗变换器(negative impedance converter)或NIC。下图这种NIC的经典运算放大器实现：
![alt text](<Pictures/Who’s Afraid of Positive Feedback-image-2.png>)

+ 从图（a）可以看出，电路中存在一个负反馈：当A点电压上升，C点输出电压上升，导致B点电压上升，从而使得C点输出电压下降，达到稳定的效果
  + 根据虚短虚断原则，可以知道$V_A=V_B=V_{in}$，而流过$R_1,R_2$的电流是一样的，因此$V_C=2V_{in}$，所以电路可以用增益为2的放大器来等效，如图（b）所示
+ 如图（b）所示，是（a）的等效图，当$V_{in}=1V$时，$V_C=2V$，所以必定会有1A的电流流进结点A（当$R_3=1\Omega$的时候，且放大器不流电流），这表示电路“反哺”了输入电压源，导致在结点A看到的是负阻$-R_3$；从输出阻抗的角度来看，想看结点A的阻抗，就要在结点A施加一个电压源$V_{in}$，求出$I$，用$V/I$来表示，这里的$I=\frac{V_A-V_C}{R_3}=\frac{-V_{in}}{R_3}$，于是从结点A来看，这个电路产生了负阻结点，于是可以得出结论：**整个NIC电路等效于A点有个$-R_3$电阻接地**
+ 负阻的一个好处是如果用它来驱动一个实际的电阻负载$R_L$，那么净电阻就是$R_L \parallel -R_3$。如果R3和RL相差不大，电阻并联的阻值会很大
+ 当电压源还存在的时候，$V_A$被强制设定为了$V_{in}$，但如果将电压源换为实际的阻抗，当C点电压升高时，A点的电压也会跟着升高，导致进一步升高C点电压，于是电路中存在正反馈和负反馈两条路径。所以我们需要让负反馈路径的增益大于正反馈回路，从而保证电路的稳定性，由于电路整体从外面看进去阻抗为$R_L \parallel -R_3$，所以只要让$R_L < R_3$即可满足条件
+ （c）图是如何使用该NIC的示例。性能较弱的驱动器无法处理低电阻负载，因此将负电阻与其并联，此时驱动器看到的阻抗更高
+ 如果需要驱动的是高电阻负载，则可以将电流源接入负反馈回路，这个时候需要保证$R_L>R_{3,4}$，如图（d）所示，这也被叫做开路稳定，而（a）图被称为短路稳定
+ 此外，负阻抗的应用也不局限于电阻，电容也可以
  + A点的阻抗：$Z_A=-\frac{Z_2\cdot Z_3}{Z_1}$
  + B点的阻抗：$Z_B=-\frac{Z_4\cdot Z_1}{Z_3}$

下图是一个更纯粹的负阻抗电路，交叉耦合对经常出现在比较器的设计中，整体阻抗为：$\frac{2}{g_{m1,4}-g_{m2,3}}$
![alt text](<Pictures/Who’s Afraid of Positive Feedback-image-3.png>)
当$g_{m1,4}<g_{m2,3}$时，整体呈现负阻抗的特性，从而会产生迟滞效应
![alt text](<Pictures/Who’s Afraid of Positive Feedback-image-4.png>)
在由NMOS差分对驱动时这是一个很有吸引力的前置放大器（将小信号差放大）：因为这是自偏置的，具有非常小的共模响应。与相同阻抗的电阻负载相比，它通常占用更少的电压裕量。而且与电阻负载不同，它具有有限的摆幅，这对于比较器来说非常理想（充放电时间更短）。当处理缓慢变化的输入时，少量的迟滞甚至可以解决比较器的亚稳态问题

## 零阻抗

前面是将正阻抗与负阻抗并联，从而得到了非常大的负载阻抗。接下来，我们将正负阻抗串联起来，然后分析串联结构的特性，这里以跨导放大器（电压——电流放大器/仪表放大器）为例
下图（a）图是个经典的V——I转换器，电阻$R_1$在交流状态下可以看作带源极负反馈的放大电路，是牺牲了跨导换取线性度；但是在大信号条件下，任何流经$R_1$的电流都会导致两边$V_{gs}$的不匹配，从而恶化线性度
![alt text](<Pictures/Who’s Afraid of Positive Feedback-image-5.png>)
该拓扑结构的跨导为：$1/(R+2/\mathrm{g}_{\mathrm{m}})$，这受PVT和偏置条件的影响很大，而理想条件下跨导应该为$1/R$

为了更接近理想性能，可以在每个晶体管周围构建负反馈环路以保持其漏极电流固定，事实上这在商用仪表放大器中几乎是通用做法，如下图所示：
![alt text](<Pictures/Who’s Afraid of Positive Feedback-image-6.png>)
A点B点电压为：
$$\begin{cases}
  V(\mathrm{A})=V_{\mathrm{inc}}-V_{\mathrm{gs}2}-V_{\mathrm{gs}3}\\
  V(\mathrm{B})=V_{\mathrm{int}}-V_{\mathrm{gs}1}-V_{\mathrm{gs}4}
\end{cases}$$
将$V_{gs}$写作电流的函数，可以得到
$$\begin{cases}
  V(\mathrm{A})=V_{\mathrm{inc}}-f(I_{\mathrm{oc}})-f(I_{\mathrm{ot}})\\
  V(\mathrm{B})=V_{\mathrm{int}}-f(I_{\mathrm{ot}})-f(I_{\mathrm{oc}})
\end{cases}$$
两式相减，有：$$V(\mathrm{A})-V(\mathrm{B})=V_{\mathrm{inc}}-V_{\mathrm{int}}$$
这表示电路功能完全独立于偏置条件。实际上，此时我们完全不需要考虑两个偏置电流源的匹配问题
而在A图中$$V(\mathrm{A})-V(\mathrm{B})=V_{\mathrm{int}}-V_{\mathrm{inc}}$$
因为交叉耦合对的存在，致使符号发生了反转，而电阻$R_1$的存在又使得环路增益离开了1这个点，从而避免了可能的不稳定（正反馈回路增益需要小于1）
这个电路的阻抗为：$$Z_{in}=\frac{v_t}{i_t}=-R-\frac{2}{g_{m1,2}}$$
![alt text](<Pictures/Who’s Afraid of Positive Feedback-image-7.png>)
若将$M_1,M_2$接成二极管形式，则二极管接法的MOS管和下方交叉耦合对的负阻抗形成抵消，最终只剩下电阻R，消除MOS管引起的非线性
![alt text](<Pictures/Who’s Afraid of Positive Feedback-image-8.png>)
（d）图中展示的是（b）图中电阻上的电压，颜色代表-55°C（蓝色）、27°C（绿色）和125°C（红色）
可见电压会在很大的差模输入范围内保持稳定
（e）图表示R1电压的导数，点划线为电路（b），虚线为电路（a），（f）为电路c的差分电阻值
如果不考虑电压裕度消耗的话，这是个很好的自偏置电路
![alt text](<Pictures/Who’s Afraid of Positive Feedback-image-10.png>)

## 无处不在的正反馈

到目前为止，正反馈最广泛的应用形式是自偏置电路，例如PTAT单元、恒定跨导发生器和电压基准。事实上，这些电路非常常见且不起眼，以至于许多用户可能甚至没有注意到其中的正反馈。
如下图（a）的constant gm电路为例：一开始$M_1$的栅极电压很小，$R_1$几乎不起作用，$M_1$栅极电压的上升导致的电流上升通过PMOS电流镜流回$M_1$栅极，从而使得电流越来越大，后面$R_1$电阻开始发力，抵消这种电流的增大，从而使得正负反馈相互抵消，最后会达到一个稳定的工作点
![alt text](<Pictures/Who’s Afraid of Positive Feedback-image-11.png>)

## 正负反馈并行进行

正如前面讨论的两个电路，他们能够稳定的条件都是正负反馈并行进行（constant gm电路前期只有正反馈，后面正负反馈同时进行）
在上图（d）中也能清楚地展现：1) 将端子X中的电流“传送”到端子Y，2) 将端子Y处的电压传送到端子X。从而实现一个环路两种功能。

这里再举一个NLA（nice/nasty little amplifier）的例子：其本质在于，通过控制差分输入对的尾电流以跟踪输出端的负载电流，实现极高的增益。
![alt text](<Pictures/Who’s Afraid of Positive Feedback-image-12.png>)
这其实就是一个接成了单位负反馈形式的两级OTA，将差分对管和上面的电流镜选择一个扭一下就能看出来
![alt text](<Pictures/Who’s Afraid of Positive Feedback-image-13.png>)
$M_6,M_8$管引入的正反馈是为了保持在共模条件下$N_2$结点的电压与$N_1$电压相同：
+ 如果$N_1$电压上升，导致$M_6$支路电流下降
+ $M_6$支路电流下降导致$M_7$栅极电压下降，导致尾电流管提供更小的电流
+ 输入对管两侧流过更小的电流，使得$N_1,N_2$结点的电压继续上升

由于$N_1$结点的电压几乎由负反馈回路决定，所以可以认为对于$N_1$而言不存在正反馈回路，而$N_2$点电压的上升是实打实的， 只不过这个电压只是为了跟随$N_1$，正反馈很微弱

根据正反馈回路的增益大小，可分类为以下三种：
+ Loop Gain < 1：除非发生某些改变增益的情况，否则绝不会对稳定性构成威胁
+ Loop Gain = 1：正反馈的“最佳点”，用于环路增益精确值并非关键的场合
+ Loop Gain > 1：仅用于负反馈回路占主导的电路中，或正反馈路径的高频部分占主导地位的情况
